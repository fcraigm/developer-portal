---
title: Lifecycle Webhooks
sidebar_position: 1
---


## Webhook Example Payloads

### ExtensionAddedToContext

```json
{
  "apiVersion": "v1",
  "kind": "ExtensionAddedToContext",

  "id": "d990eb39-041b-40b4-abb9-7a39678a0464",
  "context": {
    "id": "ecdae35d-8da2-430e-9ca8-bff36cd1f65e",
    "kind": "customer"
  },
  "consentedScopes": ["mail:read", "mail:write", "domain:read"],
  "state": {
    "enabled": true
  },
  "meta": {
    "createdAt": "2024-02-25T13:45:23Z"
  },
  "secret": "ROFLieg83rjfdoi9lLIifdlfi399fndLKFHj39fjdlr",
  "request": {
    "id": "018e60ef-ad4d-78d5-97c0-e0405b48ad89",
    "createdAt": "2024-03-14T11:36:24Z",
    "target": {
      "method": "POST",
      "url": "https://extension.domain.de/v1/webhook/..."
    }
  }
}
```

### ExtensionInstanceUpdated

```json
{
  "apiVersion": "v1",
  "kind": "ExtensionInstanceUpdated",

  "id": "d990eb39-041b-40b4-abb9-7a39678a0464",
  "context": {
    "id": "ecdae35d-8da2-430e-9ca8-bff36cd1f65e",
    "kind": "customer"
  },
  "consentedScopes": ["mail:read", "mail:write", "domain:read", "domain:write"],
  "state": {
    "enabled": true
  },
  "meta": {
    "createdAt": "2024-02-25T13:45:23Z"
  },
  "request": {
    "id": "018e60ef-ad4d-78d5-97c0-e0405b48ad89",
    "createdAt": "2024-03-14T11:36:24Z",
    "target": {
      "method": "POST",
      "url": "https://extension.domain.de/v1/webhook/..."
    }
  }
}
```

### ExtensionInstanceSecretRotated

```json
{
  "apiVersion": "v1",
  "kind": "ExtensionInstanceUpdated",

  "id": "d990eb39-041b-40b4-abb9-7a39678a0464",
  "secret": "LOLieg83rjfdoi9lLIifdlfi399fndLKFHj39fjdlr",

  "request": {
    "id": "018e60ef-ad4d-78d5-97c0-e0405b48ad89",
    "createdAt": "2024-03-14T11:36:24Z",
    "target": {
      "method": "POST",
      "url": "https://extension.domain.de/v1/webhook/..."
    }
  }
}
```

### ExtensionInstanceRemovedFromContext

```json
{
  "apiVersion": "v1",
  "kind": "ExtensionInstanceRemovedFromContext",

  "id": "d990eb39-041b-40b4-abb9-7a39678a0464",
  "context": {
    "id": "ecdae35d-8da2-430e-9ca8-bff36cd1f65e",
    "kind": "customer"
  },
  "consentedScopes": ["mail:read", "mail:write", "domain:read", "domain:write"],
  "state": {
    "enabled": true
  },
  "meta": {
    "createdAt": "2024-02-25T13:45:23Z"
  },
  "request": {
    "id": "018e60ef-ad4d-78d5-97c0-e0405b48ad89",
    "createdAt": "2024-03-14T11:36:24Z",
    "target": {
      "method": "POST",
      "url": "https://extension.domain.de/v1/webhook/..."
    }
  }
}
```


## Validierung von Lifecycle Webhooks

Um sicherzustellen, dass der Webhook von mittwald ausging, bieten wir die Möglichkeit, die Identität des Senders und den Inhalt des Request Bodys zu verifizieren. Dazu signieren wir den versendeten Request Body und schicken die Signatur inklusive der Meta-Informationen darüber in Request-Headern mit.

```
X-Marketplace-Signature-Serial: 7f640dcf-c5fb-4e79-bc4b-99a30e50fcc5
X-Marketplace-Signature-Algorithm: Ed25519
X-Marketplace-Signature: HKdS7xD...qQMN94HINte7Dlof+9V/PQ6gW0C5uBOz+9F6YNOLE6vdb2ybVwRH23GAg==
```

### X-Marketplace-Signature-Serial

Eindeutige ID des zur Überprüfung der Signatur zu nutzenden Public Keys. Wir garantieren für eine Public Key ID einen stabilen Public Key. Dadurch kann der Public Key gecached werden. Ist eine ID unbekannt, kann der Key mit der Operation [`extension-get-public-key`](https://api.mittwald.de/v2/docs/#/default/extension-get-public-key) über die mittwald-API bezogen werden.

### X-Marketplace-Signature-Algorithm

Algorithmus, der zum Erzeugen der Signatur verwendet wurde, derzeit immer [`Ed25519`](https://datatracker.ietf.org/doc/html/rfc8032).

### X-Marketplace-Signature

[DSA-Signatur](https://www.rfc-editor.org/rfc/rfc6605.html) in Base64 codiert.

Um die Signatur zu prüfen, kann eine übliche kryptographische Library in der gewählten Programmiersprache verwendet werden. Dazu wird mithilfe der `verify`-Methode der gesamte, unverarbeitete Request Body geprüft. Damit ist sichergestellt, dass der übermittelte Request Body unmodifiziert von mittwald übertragen wurde.

```go
bodyBytes, err := io.ReadAll(body)
if err != nil {
   return err
}

if !ed25519.Verify(publicKey, bodyBytes, signature) {
   panic("invalid signature")
}
```

## Request Meta Informationen

Weitere Angriffsvektoren, wie [Replay](https://csrc.nist.gov/glossary/term/replay_attack) oder Forward Replay Attacks, können ausgeschlossen werden indem die `request`-Property validiert wird.

Um den selben Request nur einmalig zu akzeptieren, kann die `request.id` persistiert werden.

Um zu überprüfen, ob der Request den richtigen Empfänger erreicht, kann das Feld `request.target.url` überprüft werden.

Um veraltete Requests erkennen zu können, bietet das Feld `request.createdAt` einen Anhaltspunkt.

### Referenzimplementierungen für die Validierung von Lifecycle Webhooks

TODO